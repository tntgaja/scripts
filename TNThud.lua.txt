-- PureGUI Pro V9 - Clean Framework Edition | Mobile Stable | No Drift | Safe Multi-Inject | Clamp + Debounce + Reactive Full
-- Fix từ V8: Clamp drag, realtime ViewportSize, relative pos no drift, debounce tween, disconnect conn, floating separate rel, scale min/max, camera change handle

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local PlayerGui = player:WaitForChild("PlayerGui")

-- ========== CLEAN OLD & CONNECTIONS ==========
local connections = {}

local function cleanup()
    for _, conn in ipairs(connections) do
        pcall(function() conn:Disconnect() end)
    end
    connections = {}
    local old = PlayerGui:FindFirstChild("PureGUI_V9")
    if old then old:Destroy() end
end
cleanup()  -- Run lần đầu

-- ========== SCALE SYSTEM ==========
local function getScale()
    local cam = workspace.CurrentCamera
    if not cam then return 1 end
    local v = cam.ViewportSize
    return math.clamp(math.min(v.X/1920, v.Y/1080), 0.6, 1.4)
end

local function getRelativePos(frame, viewport)
    local centerX = frame.Position.X.Offset + frame.AbsoluteSize.X / 2
    local centerY = frame.Position.Y.Offset + frame.AbsoluteSize.Y / 2
    return centerX / viewport.X, centerY / viewport.Y
end

local function applyRelativePos(frame, relX, relY, viewport, size)
    local offsetX = relX * viewport.X - size.X.Offset / 2
    local offsetY = relY * viewport.Y - size.Y.Offset / 2
    frame.Position = UDim2.new(0, offsetX, 0, offsetY)
end

-- ========== MAIN FRAME ==========
local scale = getScale()
local viewport = workspace.CurrentCamera.ViewportSize

local main = Instance.new("Frame")
main.Name = "Main"
main.Size = UDim2.new(0, 420*scale, 0, 300*scale)
main.Position = UDim2.new(0.5, -210*scale, 0.5, -150*scale)
main.BackgroundColor3 = Color3.fromRGB(15,15,20)
main.Visible = true
main.Parent = gui
main.ZIndex = 100

Instance.new("UICorner", main).CornerRadius = UDim.new(0, 14)
Instance.new("UIStroke", main).Color = Color3.fromRGB(80,160,255)

-- ========== TITLE ==========
local title = Instance.new("TextLabel", main)
title.Size = UDim2.new(1,0,0,40*scale)
title.BackgroundTransparency = 1
title.Text = "PureGUI Pro V9"
title.Font = Enum.Font.GothamBold
title.TextSize = 16*scale
title.TextColor3 = Color3.new(1,1,1)

-- ========== CLOSE BUTTON ==========
local close = Instance.new("TextButton", main)
close.Size = UDim2.new(0,40*scale,0,40*scale)
close.Position = UDim2.new(1,-45*scale,0,0)
close.Text = "X"
close.Font = Enum.Font.GothamBold
close.TextSize = 16*scale
close.BackgroundTransparency = 1
close.TextColor3 = Color3.fromRGB(255,90,90)

-- ========== FLOATING BUTTON ==========
local float = Instance.new("TextButton")
float.Size = UDim2.new(0,55*scale,0,55*scale)
float.Position = UDim2.new(1,-70*scale,1,-70*scale)
float.BackgroundColor3 = Color3.fromRGB(60,140,255)
float.Text = "GUI"
float.Font = Enum.Font.GothamBold
float.TextSize = 14*scale
float.TextColor3 = Color3.new(1,1,1)
float.Parent = gui
float.ZIndex = 9999

Instance.new("UICorner", float).CornerRadius = UDim.new(1,0)

-- ========== DRAG SYSTEM (clamp realtime) ==========
local draggingMain, dragStartMain, startPosMain
local draggingFloat, dragStartFloat, startPosFloat

-- Drag Main (titlebar)
title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingMain = true
        dragStartMain = input.Position
        startPosMain = main.Position
    end
end)

-- Drag Floating
float.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingFloat = true
        dragStartFloat = input.Position
        startPosFloat = float.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    local viewport = workspace.CurrentCamera.ViewportSize
    local buffer = 20

    if draggingMain and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStartMain
        local newX = startPosMain.X.Offset + delta.X
        local newY = startPosMain.Y.Offset + delta.Y
        newX = math.clamp(newX, buffer, viewport.X - main.AbsoluteSize.X - buffer)
        newY = math.clamp(newY, buffer, viewport.Y - main.AbsoluteSize.Y - buffer)
        main.Position = UDim2.new(0, newX, 0, newY)
    end

    if draggingFloat and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStartFloat
        local newX = startPosFloat.X.Offset + delta.X
        local newY = startPosFloat.Y.Offset + delta.Y
        newX = math.clamp(newX, buffer, viewport.X - float.AbsoluteSize.X - buffer)
        newY = math.clamp(newY, buffer, viewport.Y - float.AbsoluteSize.Y - buffer)
        float.Position = UDim2.new(0, newX, 0, newY)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        draggingMain = false
        draggingFloat = false
    end
end)

-- ========== TOGGLE & DEBOUNCE ==========
local isToggling = false
float.MouseButton1Click:Connect(function()
    if isToggling then return end
    isToggling = true
    main.Visible = not main.Visible
    task.delay(0.3, function() isToggling = false end)
end)

-- ========== CLOSE ==========
close.MouseButton1Click:Connect(function()
    cleanup()
end)

-- ========== REACTIVE SCALE & RELATIVE POS (no drift) ==========
local relMainX, relMainY = 0.5, 0.5
local relFloatX, relFloatY = 1, 1

local function updateScaleAndPos()
    local cam = workspace.CurrentCamera
    if not cam then return end

    local oldViewport = cam.ViewportSize
    scale = getScale()

    -- Update main size & relative pos (no reset)
    main.Size = UDim2.new(0, 420*scale, 0, 300*scale)
    applyRelativePos(main, relMainX, relMainY, oldViewport, main.Size)

    -- Update title & close scale
    title.TextSize = 16*scale
    close.Size = UDim2.new(0,40*scale,0,40*scale)
    close.Position = UDim2.new(1,-45*scale,0,0)

    -- Update floating size & relative pos (no reset)
    float.Size = UDim2.new(0,55*scale,0,55*scale)
    applyRelativePos(float, relFloatX, relFloatY, oldViewport, float.Size)
end

-- ViewportSize reactive
table.insert(connections, workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(updateScaleAndPos))

-- Camera change handle
table.insert(connections, workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
    task.wait(0.1)
    if workspace.CurrentCamera then
        updateScaleAndPos()
        -- Reconnect ViewportSize nếu cần (nhưng vì dùng workspace.CurrentCamera nên auto update)
    end
end))

print("PureGUI Pro V9 Loaded Successfully - Clamp, Debounce, Relative No Drift, Safe Multi-Inject")